---
title: "Convergence and Efficiency Evaluation"
author: Mauricio Garnier-Villarreal
bibliography:
  - refs.bib
---

```{r pkgld, include=FALSE}
library(blavaan, quietly=TRUE)
library(lavaan, quietly=TRUE)
load("conv_eff_out.RData")
```

### Introduction 

When Bayesian models estimated with Markov-Chain Monte Carlo (MCMC) sampler, the models doesnt stop when it has achieve some convergence criteria, it will run as long as you set it to, and then you need to evaluate the convergence and efficiency of the estimated posterior distributions. And only analyze the results if they are stable enough. 

For this example we will use the Industrialization and Political Democracy example [@bollen_structural_1989]. 

```{r, eval=F}
model <- '
  # latent variable definitions
     ind60 =~ x1 + x2 + x3
     dem60 =~ a*y1 + b*y2 + c*y3 + d*y4
     dem65 =~ a*y5 + b*y6 + c*y7 + d*y8

  # regressions
    dem60 ~ ind60
    dem65 ~ ind60 + dem60

  # residual correlations
    y1 ~~ y5
    y2 ~~ y4 + y6
    y3 ~~ y7
    y4 ~~ y8
    y6 ~~ y8
'

fit <- bsem(model, data=PoliticalDemocracy,
            std.lv=T, meanstructure=T, n.chains=3,
            burnin=500, sample=1000)
```


### Convergence 

$\hat{R}$ is the convergence diagnostic, which compares the between- and within-chain estimates for model parameters and other univariate quantities of interest [@new_rhat]. If chains have not mixed well (ie, the between- and within-chain estimates don't agree), $\hat{R}$ is larger than 1. We recommend running at least three chains by default and only using the sample if $\hat{R} < 1.05$ for all the parameters. 

```blavaan``` presents the $\hat{R}$ reported by the underlying MCMC program, either Stan or JAGS (Stan by default). We can report the $\hat{R}$ from ```summary()``` function, and can also extract it with the ```blavInspect()``` function

```{r}
blavInspect(fit, "psrf")
```

But with large models can be cumbersome to look over all of them, we can find the higest $\hat{R}$ to see if they are all $\hat{R} < 1.05$

```{r}
max(blavInspect(fit, "psrf"))
```

If all $\hat{R} < 1.05$ then we can establish that the MCMC chains have converged to a stable solution. If the model has not converged, you shoudl increase the number of ```burnin``` iterations 

```{r, eval=F}
fit <- bsem(model, data=PoliticalDemocracy,
            std.lv=T, meanstructure=T, n.chains=3,
            burnin=1000, sample=1000)
```

and/or change the model priors with the ```dpriors()``` function. As the model might have failed to converge due to needing more iterations or a model misspecification (such as bad priors)

### Efficiency

We should alsoevaluate the efficiency of the posterior distributions, Effecitive sample size (ESS) is a useful measure for sampling efficiency in the distribution (related e.g. to efficiency of mean and median estimates), and is well defined even if the chains do not have finite mean or variance [@new_rhat].

In short, ESS can be interpreted as the number of posterior draws that are completely independent of each other, with auto-correlations of 0. In ```blavaan``` we can print it from the ```summary``` function with the ```neff``` argument

```{r, eval=F}
summary(fit, neff=T)
```

We can also extract only those with the ```blavInspect()``` function

```{r}
blavInspect(fit, "neff")
```

ESS should be at least 100 (approximately) per Markov Chain in order to be reliable and indicate that estimates of respective posterior quantiles are reliable. In this example, that would be to have at least ```neff=300``` for every parameter. 

We can focus on the lowest ESS with the ```min()``` function

```{r}
min(blavInspect(fit, "neff"))
```


### References
